name: Create GitHub Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build release body from CHANGELOG
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          VERSION="${TAG_NAME#v}"
          python - <<'PY'
          import os, re, sys

          tag = os.environ.get("TAG_NAME", "").strip()
          if not tag:
            print("TAG_NAME ontbreekt.", file=sys.stderr)
            raise SystemExit(1)

          version = tag[1:] if tag.startswith("v") else tag
          changelog = open("CHANGELOG.md", "r", encoding="utf-8").read().splitlines()

          start = None
          needle = f"## [{version}]"
          for i, line in enumerate(changelog):
            if line.startswith(needle):
              start = i
              break

          if start is None:
            print(f"Kon geen CHANGELOG sectie vinden voor versie {version} (tag: {tag}).", file=sys.stderr)
            raise SystemExit(1)

          out = []
          for line in changelog[start:]:
            if out and line.startswith("## ["):
              break
            out.append(line)

          body = "\n".join(out).strip() + "\n"
          open("release-body.md", "w", encoding="utf-8").write(body)
          PY

      - name: Create release from tag
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-body.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
