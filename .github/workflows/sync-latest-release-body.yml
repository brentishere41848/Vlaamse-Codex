name: Sync Latest Release Body

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update latest release body from CHANGELOG
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            function extractChangelogSection(changelogText, version) {
              const lines = String(changelogText || "").split(/\r?\n/);
              const headerPrefix = `## [${version}]`;

              let start = -1;
              for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith(headerPrefix)) {
                  start = i;
                  break;
                }
              }
              if (start === -1) return null;

              const out = [];
              for (let i = start; i < lines.length; i++) {
                if (i !== start && lines[i].startsWith("## [")) break;
                out.push(lines[i]);
              }
              return out.join("\n").trim();
            }

            const { owner, repo } = context.repo;
            const latest = await github.rest.repos.getLatestRelease({ owner, repo });
            const tag = latest.data.tag_name || "";
            const version = tag.startsWith("v") ? tag.slice(1) : tag;

            const changelog = fs.readFileSync("CHANGELOG.md", "utf8");
            const body = extractChangelogSection(changelog, version);
            if (!body) {
              core.setFailed(`Kon geen CHANGELOG sectie vinden voor versie ${version} (tag: ${tag}).`);
              return;
            }

            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: latest.data.id,
              name: tag,
              body
            });

            core.info(`Release ${tag} bijgewerkt met CHANGELOG sectie ${version}.`);
